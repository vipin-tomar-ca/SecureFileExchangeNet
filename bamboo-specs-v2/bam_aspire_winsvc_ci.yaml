version: 2
plan:
  name: Aspire Windows Service CI
  key: ASPIREWINCI
  project: ASPIRE

stages:
  - Build
  - Test
  - Package

triggers:
  - polling:
      interval: 300

variables:
  solution.name: MyAspireApp.sln
  apphost.project: src/MyAspireApp.AppHost
  output.path: artifacts

source-repository:
  type: git
  url: https://github.com/your-repo.git
  branch: main

tasks:
  - stage: Build
    jobs:
      - name: Build Solution
        tasks:
          - script:
              name: Restore and Build
              script: |
                dotnet restore $solution.name
                dotnet build $solution.name -c Release --no-restore

  - stage: Test
    jobs:
      - name: Run Tests
        tasks:
          - script:
              name: Execute tests
              script: dotnet test $solution.name -c Release --no-build

  - stage: Package
    jobs:
      - name: Package Services
        tasks:
          - script:
            interpreter: POWERSHELL
            file: bamboo-specs-v2/generate_manifest.ps1
            description: Generate Aspire Manifest (Windows)
            arguments: -OutputPath "$output.path"

          - script:
            interpreter: POWERSHELL
            file: bamboo-specs-v2/publish_pack.ps1
            description: Publish and Package Projects (Windows)
            arguments: -OutputPath "$output.path"


          - artifacts:
              name: Save Artifacts
              location: $output.path
              pattern: "*.zip"
              shared: true